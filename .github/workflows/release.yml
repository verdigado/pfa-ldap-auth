name: Release Go Binary

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - run: apt install golang curl jq
      - run: go get .
      - run: go build .
      - run: RESPONSE=$(curl -L -X POST -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/verdigado/pfa-ldap-auth/releases  -d '{"tag_name":"${{ github.ref }}","target_commitish":"master","name":"${{ github.ref }}","body":"Version ${{ github.ref }}","draft":false,"prerelease":false,"generate_release_notes":false}')
      - run: RELEASE_ID=$(echo "$RESPONSE" | jq .id)
      - run: curl -L -X POST -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" -H "Content-Type: application/octet-stream" --data-binary @"pfa-ldap-auth" "https://uploads.github.com/repos/verdigado/pfa-ldap-auth/releases/$RELEASE_ID/assets?name=pfa-ldap-auth"
